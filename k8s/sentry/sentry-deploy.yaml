kind: Pod
apiVersion: v1
metadata:
  name: sentry-relay
  labels:
    app: sentry
spec:
  hostNetwork: true
  containers:
    - name: sentry-relay
      image: getsentry/relay:22.6.0
      ports:
        - containerPort: 3000
      volumeMounts:
        - mountPath: /work/.relay
          name: v-relay-config
        - mountPath: /geoip
          name: v-relay-geoip
  volumes:
    - name: v-relay-config
      hostPath:
        # 相对路径不行
        path: /sentry/relay
    - name: v-relay-geoip
      hostPath:
        path: /sentry/geoip
---

kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-api
  labels:
    app: sentry-snuba-api
spec:
  containers:
    - name: sentry-snuba-api
      image: getsentry/snuba:22.6.0
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
---
kind: Service
apiVersion: v1
metadata:
  name: sentry-snuba-api
spec:
  selector:
    app: sentry-snuba-api
  type: NodePort
  ports:
    # Default port used by the image
    - port: 1218
      targetPort: 1218
---

kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-consumer
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-consumer
      image: getsentry/snuba:22.6.0
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "snuba", "consumer", "--storage", "errors", "--auto-offset-reset=latest", "--max-batch-time-ms", "750" ]
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-outcomes-consumer
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-outcomes-consumer
      image: getsentry/snuba:22.6.0
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "snuba", "consumer", "--storage", "outcomes_raw", "--auto-offset-reset=earliest", "--max-batch-time-ms", "750" ]
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-sessions-consumer
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-sessions-consumer
      image: getsentry/snuba:22.6.0
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "snuba", "consumer", "--storage", "sessions_raw", "--auto-offset-reset=latest", "--max-batch-time-ms", "750" ]
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-transactions-consumer
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-transactions-consumer
      image: getsentry/snuba:22.6.0
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "snuba", "consumer", "--storage", "transactions", "--consumer-group", "transactions_group" ,"--auto-offset-reset=latest", "--max-batch-time-ms", "750", "--commit-log-topic=snuba-commit-log" ]
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-replacer
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-replacer
      image: getsentry/snuba:22.6.0
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "snuba", "replacer", "--storage", "errors", "--auto-offset-reset=latest", "--max-batch-size", "3" ]
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-subscription-consumer-events
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-subscription-consumer-events
      image: getsentry/snuba:22.6.0
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "snuba", "subscriptions-scheduler-executor", "--dataset", "events", "--entity", "events", "--auto-offset-reset=latest", "--no-strict-offset-reset", "--consumer-group=snuba-events-subscriptions-consumers", "--followed-consumer-group=snuba-consumers" ,"--delay-seconds=60" ,"--schedule-ttl=60" ,"--stale-threshold-seconds=900" ]
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-subscription-consumer-transactions
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-subscription-consumer-transactions
      image: getsentry/snuba:22.6.0
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "snuba",  "subscriptions-scheduler-executor", "--dataset", "transactions", "--entity", "transactions", "--auto-offset-reset=latest","--no-strict-offset-reset", "--consumer-group=snuba-transactions-subscriptions-consumers", "--followed-consumer-group=transactions_group", "--delay-seconds=60", "--schedule-ttl=60", "--stale-threshold-seconds=900" ]
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-cleanup
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-cleanup
      image: snuba-cleanup-self-hosted-local:latest
      imagePullPolicy: Never  # or IfNotPresent
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "*/5 * * * *", "gosu", "snuba", "snuba", "cleanup", "--storage", "errors", "--dry-run", "False" ]
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-snuba-transactions-cleanup
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-snuba-transactions-cleanup
      imagePullPolicy: Never  # or IfNotPresent
      image: snuba-cleanup-self-hosted-local:latest
      env:
        - name: SNUBA_SETTINGS
          value: "distributed"
        - name: CLICKHOUSE_HOST
          value: "172.17.183.16"
        - name: DEFAULT_BROKERS
          value: "172.17.183.16:9092"
        - name: REDIS_HOST
          value: 172.17.183.16
        - name: UWSGI_MAX_REQUESTS
          value: "10000"
        - name: UWSGI_DISABLE_LOGGING
          value: "true"
        # Leaving the value empty to just pass whatever is set
        # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value:
      command: [ "*/5 * * * *", "gosu", "snuba", "snuba", "cleanup", "--storage", "transactions", "--dry-run", "False" ]
---
#
#
#
#

#
kind: Pod
apiVersion: v1
metadata:
  name: sentry-web
  labels:
    app: sentry-web
spec:
  hostNetwork: true
  containers:
    - name: sentry-web
      image: sentry-self-hosted-local:latest
      imagePullPolicy: Never  # or IfNotPresent
      command: [ "/etc/sentry/entrypoint.sh" ]
      args: [ "run", "web" ]
      ports:
        - containerPort: 9000
      env:
        - name: PYTHONUSERBASE
          value: "/data/custom-packages"
        - name: SENTRY_CONF
          value: "/etc/sentry"
        - name: SNUBA
          value: "http://sentry-snuba-api:1218"
        - name: DEFAULT_CA_BUNDLE
          value: &ca_bundle "/etc/ssl/certs/ca-certificates.crt"
          # This one is used by requests
        - name: REQUESTS_CA_BUNDLE
          value: *ca_bundle
          # This one is used by grpc/google modules
        - name: GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR
          value: *ca_bundle
          # Leaving the value empty to just pass whatever is set
          # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value: "90"
        - name: SENTRY_MAIL_HOST
          value: sentry-mail
      volumeMounts:
        - mountPath: /etc/sentry
          name: v-sentry-config
        - mountPath: /geoip
          name: v-sentry-geoip
  volumes:
    - name: v-sentry-config
      hostPath:
        # 相对路径不行
        path: /sentry/sentry
    - name: v-sentry-geoip
      hostPath:
        path: /sentry/geoip
---
kind: Service
apiVersion: v1
metadata:
  name: sentry-web
spec:
  selector:
    app: sentry-web
  type: NodePort
  ports:
    # Default port used by the image
    - port: 9000
      targetPort: 9000

---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-cron
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-cron
      image: sentry-self-hosted-local:latest
      imagePullPolicy: Never  # or IfNotPresent
      command: [ "/etc/sentry/entrypoint.sh" ]
      args: [ "run", "cron" ]
      env:
        - name: PYTHONUSERBASE
          value: "/data/custom-packages"
        - name: SENTRY_CONF
          value: "/etc/sentry"
        - name: SNUBA
          value: "http://sentry-snuba-api:1218"
        - name: DEFAULT_CA_BUNDLE
          value: &ca_bundle "/etc/ssl/certs/ca-certificates.crt"
          # This one is used by requests
        - name: REQUESTS_CA_BUNDLE
          value: *ca_bundle
          # This one is used by grpc/google modules
        - name: GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR
          value: *ca_bundle
          # Leaving the value empty to just pass whatever is set
          # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value: "90"
        - name: SENTRY_MAIL_HOST
          value: sentry-mail
      volumeMounts:
        - mountPath: /etc/sentry
          name: v-sentry-config
        - mountPath: /geoip
          name: v-sentry-geoip
  volumes:
    - name: v-sentry-config
      hostPath:
        # 相对路径不行
        path: /sentry/sentry
    - name: v-sentry-geoip
      hostPath:
        path: /sentry/geoip
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-worker
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-worker
      image: sentry-self-hosted-local:latest
      imagePullPolicy: Never  # or IfNotPresent
      command: [ "/etc/sentry/entrypoint.sh" ]
      args: [ "run", "worker" ]
      env:
        - name: PYTHONUSERBASE
          value: "/data/custom-packages"
        - name: SENTRY_CONF
          value: "/etc/sentry"
        - name: SNUBA
          value: "http://sentry-snuba-api:1218"
        - name: DEFAULT_CA_BUNDLE
          value: &ca_bundle "/etc/ssl/certs/ca-certificates.crt"
          # This one is used by requests
        - name: REQUESTS_CA_BUNDLE
          value: *ca_bundle
          # This one is used by grpc/google modules
        - name: GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR
          value: *ca_bundle
          # Leaving the value empty to just pass whatever is set
          # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value: "90"
        - name: SENTRY_MAIL_HOST
          value: sentry-mail
      volumeMounts:
        - mountPath: /etc/sentry
          name: v-sentry-config
        - mountPath: /geoip
          name: v-sentry-geoip
  volumes:
    - name: v-sentry-config
      hostPath:
        # 相对路径不行
        path: /sentry/sentry
    - name: v-sentry-geoip
      hostPath:
        path: /sentry/geoip
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-ingest-consumer
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-ingest-consumer
      image: sentry-self-hosted-local:latest
      imagePullPolicy: Never  # or IfNotPresent
      command: [ "/etc/sentry/entrypoint.sh" ]
      args: [ "run", "ingest-consumer","--all-consumer-types" ]
      env:
        - name: PYTHONUSERBASE
          value: "/data/custom-packages"
        - name: SENTRY_CONF
          value: "/etc/sentry"
        - name: SNUBA
          value: "http://sentry-snuba-api:1218"
        - name: DEFAULT_CA_BUNDLE
          value: &ca_bundle "/etc/ssl/certs/ca-certificates.crt"
          # This one is used by requests
        - name: REQUESTS_CA_BUNDLE
          value: *ca_bundle
          # This one is used by grpc/google modules
        - name: GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR
          value: *ca_bundle
          # Leaving the value empty to just pass whatever is set
          # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value: "90"
        - name: SENTRY_MAIL_HOST
          value: sentry-mail
      volumeMounts:
        - mountPath: /etc/sentry
          name: v-sentry-config
        - mountPath: /geoip
          name: v-sentry-geoip
  volumes:
    - name: v-sentry-config
      hostPath:
        # 相对路径不行
        path: /sentry/sentry
    - name: v-sentry-geoip
      hostPath:
        path: /sentry/geoip
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-post-process-forwarder
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-post-process-forwarder
      image: sentry-self-hosted-local:latest
      imagePullPolicy: Never  # or IfNotPresent
      command: [ "/etc/sentry/entrypoint.sh" ]
      args: [ "run", "post-process-forwarder","--commit-batch-size" ,"1" ]
      env:
        - name: PYTHONUSERBASE
          value: "/data/custom-packages"
        - name: SENTRY_CONF
          value: "/etc/sentry"
        - name: SNUBA
          value: "http://sentry-snuba-api:1218"
        - name: DEFAULT_CA_BUNDLE
          value: &ca_bundle "/etc/ssl/certs/ca-certificates.crt"
          # This one is used by requests
        - name: REQUESTS_CA_BUNDLE
          value: *ca_bundle
          # This one is used by grpc/google modules
        - name: GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR
          value: *ca_bundle
          # Leaving the value empty to just pass whatever is set
          # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value: "90"
        - name: SENTRY_MAIL_HOST
          value: sentry-mail
      volumeMounts:
        - mountPath: /etc/sentry
          name: v-sentry-config
        - mountPath: /geoip
          name: v-sentry-geoip
  volumes:
    - name: v-sentry-config
      hostPath:
        # 相对路径不行
        path: /sentry/sentry
    - name: v-sentry-geoip
      hostPath:
        path: /sentry/geoip
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-subscription-consumer-events
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-subscription-consumer-events
      image: sentry-self-hosted-local:latest
      imagePullPolicy: Never  # or IfNotPresent
      command: [ "/etc/sentry/entrypoint.sh" ]
      args: [ "run", "query-subscription-consumer","--commit-batch-size" ,"1", "--topic", "events-subscription-results" ]
      env:
        - name: PYTHONUSERBASE
          value: "/data/custom-packages"
        - name: SENTRY_CONF
          value: "/etc/sentry"
        - name: SNUBA
          value: "http://sentry-snuba-api:1218"
        - name: DEFAULT_CA_BUNDLE
          value: &ca_bundle "/etc/ssl/certs/ca-certificates.crt"
          # This one is used by requests
        - name: REQUESTS_CA_BUNDLE
          value: *ca_bundle
          # This one is used by grpc/google modules
        - name: GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR
          value: *ca_bundle
          # Leaving the value empty to just pass whatever is set
          # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value: "90"
        - name: SENTRY_MAIL_HOST
          value: sentry-mail
      volumeMounts:
        - mountPath: /etc/sentry
          name: v-sentry-config
        - mountPath: /geoip
          name: v-sentry-geoip
  volumes:
    - name: v-sentry-config
      hostPath:
        # 相对路径不行
        path: /sentry/sentry
    - name: v-sentry-geoip
      hostPath:
        path: /sentry/geoip
---
kind: Pod
apiVersion: v1
metadata:
  name: sentry-subscription-consumer-transactions
  labels:
    app: sentry
spec:
  containers:
    - name: sentry-subscription-consumer-transactions
      image: sentry-self-hosted-local:latest
      imagePullPolicy: Never  # or IfNotPresent
      command: [ "/etc/sentry/entrypoint.sh" ]
      args: [ "run", "query-subscription-consumer","--commit-batch-size" ,"1", "--topic", "transactions-subscription-results" ]
      env:
        - name: PYTHONUSERBASE
          value: "/data/custom-packages"
        - name: SENTRY_CONF
          value: "/etc/sentry"
        - name: SNUBA
          value: "http://sentry-snuba-api:1218"
        - name: DEFAULT_CA_BUNDLE
          value: &ca_bundle "/etc/ssl/certs/ca-certificates.crt"
          # This one is used by requests
        - name: REQUESTS_CA_BUNDLE
          value: *ca_bundle
          # This one is used by grpc/google modules
        - name: GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR
          value: *ca_bundle
          # Leaving the value empty to just pass whatever is set
          # on the host system (or in the .env file)
        - name: SENTRY_EVENT_RETENTION_DAYS
          value: "90"
        - name: SENTRY_MAIL_HOST
          value: sentry-mail
      volumeMounts:
        - mountPath: /etc/sentry
          name: v-sentry-config
        - mountPath: /geoip
          name: v-sentry-geoip
  volumes:
    - name: v-sentry-config
      hostPath:
        # 相对路径不行
        path: /sentry/sentry
    - name: v-sentry-geoip
      hostPath:
        path: /sentry/geoip
---






#apiVersion: v1
#kind: Pod
#metadata:
#  name: cr
#  namespace: default
#spec:
#  containers:
#    - name: cr
#      image: curlimages/curl:7.84.0
#      command:
#        - sleep
#        - "3600"
#      imagePullPolicy: IfNotPresent
#  restartPolicy: Always


#kind: Pod
#apiVersion: v1
#metadata:
#  name: test-web
#  labels:
#    app: test
#spec:
#  containers:
#    - image: centos/httpd:latest
#      name: test-web
#      volumeMounts:
#        - mountPath: /web
#          name: test-volume
#  volumes:
#    - name: test-volume
#      hostPath:
#        path: /sentry/sentry
#        type:
